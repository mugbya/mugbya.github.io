<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ES之词频统计</title>
      <link href="/es-term-freq/"/>
      <url>/es-term-freq/</url>
      
        <content type="html"><![CDATA[<h2 id="1-缘起"><a href="#1-缘起" class="headerlink" title="1. 缘起"></a>1. 缘起</h2><p>今天在群里遇到一个需求：<strong>统计北京、天津、河北出现的总数（不是文档数目)</strong></p><p><img src="/images/es/term-freq-01.png" alt=""></p><p>期望得到 北京: 3  天津: 5  河北: 1</p><h2 id="2-实践"><a href="#2-实践" class="headerlink" title="2. 实践"></a>2. 实践</h2><p>这个需求以前没有接触过，然后去搜索下了，发现这是一个词频统计的问题</p><p>相关链接</p><ul><li><a href="https://elasticsearch.cn/question/6834" target="_blank" rel="noopener">es中怎么判断同一条信息中同一个词出现的次数</a></li><li><a href="https://developer.aliyun.com/article/707393" target="_blank" rel="noopener">Elasticsearch词频统计实现与原理解读</a></li></ul><p>然后我也简单实现了下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">POST</span> <span class="string">_bulk</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_index":"test","_type":"_doc","_id":"1"&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"cities":["北京"]&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_index":"test","_type":"_doc","_id":"2"&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"cities":["北京",</span>  <span class="string">"天津"</span><span class="string">]&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_index":"test","_type":"_doc","_id":"3"&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"cities":["河北",</span>  <span class="string">"天津"</span><span class="string">]&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_index":"test","_type":"_doc","_id":"4"&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"cities":["天津"]&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_index":"test","_type":"_doc","_id":"5"&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"cities":["北京",</span> <span class="string">"北京"</span><span class="string">,</span>  <span class="string">"天津"</span><span class="string">]&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_index":"test","_type":"_doc","_id":"6"&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"cities":["天津"]&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">GET</span> <span class="string">test/_search</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">  <span class="attr">"size":</span> <span class="number">0</span><span class="string">,</span> </span><br><span class="line">  <span class="attr">"aggs":</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"term_sum":</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">"terms":</span> <span class="string">&#123;</span></span><br><span class="line">         <span class="attr">"order":</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">"_term":</span> <span class="string">"desc"</span></span><br><span class="line">        <span class="string">&#125;,</span></span><br><span class="line">        <span class="attr">"field":</span> <span class="string">"cities.keyword"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"size":</span> <span class="number">10</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>这里使用es自带的mappings, es会自动给text类型再增加一个keyword类型，因为 text 类型不能用于聚合，以前文章有相关内容</p></blockquote><p>聚合结果也是题主想要的</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"aggregations"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">"term_sum"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">"doc_count_error_upper_bound"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">    <span class="string">"sum_other_doc_count"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">    <span class="string">"buckets"</span> <span class="string">:</span> <span class="string">[</span></span><br><span class="line">      <span class="string">&#123;</span></span><br><span class="line">        <span class="string">"key"</span> <span class="string">:</span> <span class="string">"河北"</span><span class="string">,</span></span><br><span class="line">        <span class="string">"doc_count"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">      <span class="string">&#125;,</span></span><br><span class="line">      <span class="string">&#123;</span></span><br><span class="line">        <span class="string">"key"</span> <span class="string">:</span> <span class="string">"天津"</span><span class="string">,</span></span><br><span class="line">        <span class="string">"doc_count"</span> <span class="string">:</span> <span class="number">5</span></span><br><span class="line">      <span class="string">&#125;,</span></span><br><span class="line">      <span class="string">&#123;</span></span><br><span class="line">        <span class="string">"key"</span> <span class="string">:</span> <span class="string">"北京"</span><span class="string">,</span></span><br><span class="line">        <span class="string">"doc_count"</span> <span class="string">:</span> <span class="number">3</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">]</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>我以为自此这个需求我就实现了，本质是<strong>数据进入es会被拆成token(词元), 然后就是对词元的一个频率统计</strong></p><p>结果一会群主补了一篇文章 <a href="https://wx.zsxq.com/dweb2/index/topic_detail/582245525418184" target="_blank" rel="noopener">星球文章</a></p><p>一看是一个我不曾用过的api, 看了下<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/docs-multi-termvectors.html" target="_blank" rel="noopener">官方文档</a>，竟然1.3 开始就有了。 然后我对照着实现了下，</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PUT</span> <span class="string">my_index_003</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">  <span class="attr">"mappings":</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"properties":</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">"title":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"type":</span> <span class="string">"keyword"</span></span><br><span class="line">      <span class="string">&#125;,</span></span><br><span class="line">      <span class="attr">"tags":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"type":</span> <span class="string">"keyword"</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">GET</span> <span class="string">my_index_003/_search</span></span><br><span class="line"></span><br><span class="line"><span class="string">POST</span> <span class="string">my_index_003/_bulk</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_id":1&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"tags":["北京","北京","天津"]&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_id":2&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"tags":"北京"&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_id":3&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"tags":["北京","天津"]&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_id":4&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"tags":["河北","天津"]&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_id":5&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"tags":"天津"&#125;</span></span><br><span class="line"><span class="string">&#123;"index":&#123;"_id":6&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"tags":"天津"&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">POST</span> <span class="string">my_index_003/_search</span></span><br><span class="line"></span><br><span class="line"><span class="string">GET</span> <span class="string">my_index_003/_mtermvectors</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">  <span class="attr">"ids":</span> <span class="string">[</span></span><br><span class="line">    <span class="number">1</span><span class="string">,</span></span><br><span class="line">    <span class="number">2</span><span class="string">,</span></span><br><span class="line">    <span class="number">3</span><span class="string">,</span></span><br><span class="line">    <span class="number">4</span><span class="string">,</span></span><br><span class="line">    <span class="number">5</span><span class="string">,</span></span><br><span class="line">    <span class="number">6</span></span><br><span class="line">  <span class="string">],</span></span><br><span class="line">  <span class="attr">"parameters":</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"fields":</span> <span class="string">[</span></span><br><span class="line">      <span class="string">"tags"</span></span><br><span class="line">    <span class="string">],</span></span><br><span class="line">    <span class="attr">"term_statistics":</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">    <span class="attr">"offsets":</span> <span class="literal">false</span><span class="string">,</span></span><br><span class="line">    <span class="attr">"payloads":</span> <span class="literal">false</span><span class="string">,</span></span><br><span class="line">    <span class="attr">"positions":</span> <span class="literal">false</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;</span></span><br><span class="line">  <span class="string">"docs"</span> <span class="string">:</span> <span class="string">[</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line">      <span class="string">"_index"</span> <span class="string">:</span> <span class="string">"my_index_003"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_type"</span> <span class="string">:</span> <span class="string">"_doc"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_id"</span> <span class="string">:</span> <span class="string">"1"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_version"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">      <span class="string">"found"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">      <span class="string">"took"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">      <span class="string">"term_vectors"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">"tags"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">"field_statistics"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"sum_doc_freq"</span> <span class="string">:</span> <span class="number">9</span><span class="string">,</span></span><br><span class="line">            <span class="string">"doc_count"</span> <span class="string">:</span> <span class="number">6</span><span class="string">,</span></span><br><span class="line">            <span class="string">"sum_ttf"</span> <span class="string">:</span> <span class="number">9</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line">          <span class="string">"terms"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"北京"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="string">"doc_freq"</span> <span class="string">:</span> <span class="number">3</span><span class="string">,</span></span><br><span class="line">              <span class="string">"ttf"</span> <span class="string">:</span> <span class="number">3</span><span class="string">,</span></span><br><span class="line">              <span class="string">"term_freq"</span> <span class="string">:</span> <span class="number">2</span></span><br><span class="line">            <span class="string">&#125;,</span></span><br><span class="line">            <span class="string">"天津"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="string">"doc_freq"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"ttf"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"term_freq"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line">      <span class="string">"_index"</span> <span class="string">:</span> <span class="string">"my_index_003"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_type"</span> <span class="string">:</span> <span class="string">"_doc"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_id"</span> <span class="string">:</span> <span class="string">"2"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_version"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">      <span class="string">"found"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">      <span class="string">"took"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">      <span class="string">"term_vectors"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">"tags"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">"field_statistics"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"sum_doc_freq"</span> <span class="string">:</span> <span class="number">9</span><span class="string">,</span></span><br><span class="line">            <span class="string">"doc_count"</span> <span class="string">:</span> <span class="number">6</span><span class="string">,</span></span><br><span class="line">            <span class="string">"sum_ttf"</span> <span class="string">:</span> <span class="number">9</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line">          <span class="string">"terms"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"北京"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="string">"doc_freq"</span> <span class="string">:</span> <span class="number">3</span><span class="string">,</span></span><br><span class="line">              <span class="string">"ttf"</span> <span class="string">:</span> <span class="number">3</span><span class="string">,</span></span><br><span class="line">              <span class="string">"term_freq"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line">      <span class="string">"_index"</span> <span class="string">:</span> <span class="string">"my_index_003"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_type"</span> <span class="string">:</span> <span class="string">"_doc"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_id"</span> <span class="string">:</span> <span class="string">"3"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_version"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">      <span class="string">"found"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">      <span class="string">"took"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">      <span class="string">"term_vectors"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">"tags"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">"field_statistics"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"sum_doc_freq"</span> <span class="string">:</span> <span class="number">9</span><span class="string">,</span></span><br><span class="line">            <span class="string">"doc_count"</span> <span class="string">:</span> <span class="number">6</span><span class="string">,</span></span><br><span class="line">            <span class="string">"sum_ttf"</span> <span class="string">:</span> <span class="number">9</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line">          <span class="string">"terms"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"北京"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="string">"doc_freq"</span> <span class="string">:</span> <span class="number">3</span><span class="string">,</span></span><br><span class="line">              <span class="string">"ttf"</span> <span class="string">:</span> <span class="number">3</span><span class="string">,</span></span><br><span class="line">              <span class="string">"term_freq"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">            <span class="string">&#125;,</span></span><br><span class="line">            <span class="string">"天津"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="string">"doc_freq"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"ttf"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"term_freq"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line">      <span class="string">"_index"</span> <span class="string">:</span> <span class="string">"my_index_003"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_type"</span> <span class="string">:</span> <span class="string">"_doc"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_id"</span> <span class="string">:</span> <span class="string">"4"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_version"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">      <span class="string">"found"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">      <span class="string">"took"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">      <span class="string">"term_vectors"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">"tags"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">"field_statistics"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"sum_doc_freq"</span> <span class="string">:</span> <span class="number">9</span><span class="string">,</span></span><br><span class="line">            <span class="string">"doc_count"</span> <span class="string">:</span> <span class="number">6</span><span class="string">,</span></span><br><span class="line">            <span class="string">"sum_ttf"</span> <span class="string">:</span> <span class="number">9</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line">          <span class="string">"terms"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"天津"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="string">"doc_freq"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"ttf"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"term_freq"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">            <span class="string">&#125;,</span></span><br><span class="line">            <span class="string">"河北"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="string">"doc_freq"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">              <span class="string">"ttf"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">              <span class="string">"term_freq"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line">      <span class="string">"_index"</span> <span class="string">:</span> <span class="string">"my_index_003"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_type"</span> <span class="string">:</span> <span class="string">"_doc"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_id"</span> <span class="string">:</span> <span class="string">"5"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_version"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">      <span class="string">"found"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">      <span class="string">"took"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">      <span class="string">"term_vectors"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">"tags"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">"field_statistics"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"sum_doc_freq"</span> <span class="string">:</span> <span class="number">9</span><span class="string">,</span></span><br><span class="line">            <span class="string">"doc_count"</span> <span class="string">:</span> <span class="number">6</span><span class="string">,</span></span><br><span class="line">            <span class="string">"sum_ttf"</span> <span class="string">:</span> <span class="number">9</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line">          <span class="string">"terms"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"天津"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="string">"doc_freq"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"ttf"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"term_freq"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line">      <span class="string">"_index"</span> <span class="string">:</span> <span class="string">"my_index_003"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_type"</span> <span class="string">:</span> <span class="string">"_doc"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_id"</span> <span class="string">:</span> <span class="string">"6"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"_version"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">      <span class="string">"found"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">      <span class="string">"took"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">      <span class="string">"term_vectors"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">"tags"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">"field_statistics"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"sum_doc_freq"</span> <span class="string">:</span> <span class="number">9</span><span class="string">,</span></span><br><span class="line">            <span class="string">"doc_count"</span> <span class="string">:</span> <span class="number">6</span><span class="string">,</span></span><br><span class="line">            <span class="string">"sum_ttf"</span> <span class="string">:</span> <span class="number">9</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line">          <span class="string">"terms"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">"天津"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="string">"doc_freq"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"ttf"</span> <span class="string">:</span> <span class="number">5</span><span class="string">,</span></span><br><span class="line">              <span class="string">"term_freq"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>结果一看结果明白它更具体的场景，它是用在 统计文档某个字段的词频情况，也给出了该词出现在多少文档中</p><h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h2><ol><li>如果需要统计词频在总文档出现的次数，用 terms 更方便直接</li><li>如果需要查看某个文档下某字段有多少词元，及出现的频率；或者在给定文档范围情况下，统计词元 <strong>在该文档出现的次数</strong> 跟 <strong>出现在多少文档中</strong>，并不直接提供统计词元出现的总数</li></ol>]]></content>
      
      
      <categories>
          
          <category> elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>探究rabbitmq接收自动应答</title>
      <link href="/rabbitmq-auto-ack/"/>
      <url>/rabbitmq-auto-ack/</url>
      
        <content type="html"><![CDATA[<h2 id="1-缘起"><a href="#1-缘起" class="headerlink" title="1.缘起"></a>1.缘起</h2><p>最近一直在补rabbitmq知识，必须往深入拓展嘛</p><p>然后我在浏览别人的博客时，发现了关于自动应答的两种描述</p><ul><li><a href="https://segmentfault.com/a/1190000015369917" target="_blank" rel="noopener">自动应答：如果报错了，消息不会丢失，会无限循环消费，很容易就吧磁盘空间耗完</a></li><li><a href="https://blog.csdn.net/zhetmdoubeizhanyong/article/details/103223777" target="_blank" rel="noopener">MQ broker只需要确认消息发送成功，无需等待应答就会丢弃消息</a></li></ul><p>第一个说自动应答，消费异常会无限循环；第二个说只要消息发送成功，无需等待应答就会丢弃消息。那么肯定就不会有无限循环</p><p>又是两种不同的结论，我疑惑了，也来了兴趣，写了demo，也有了这篇博文</p><h2 id="2-实践"><a href="#2-实践" class="headerlink" title="2.实践"></a>2.实践</h2><h3 id="2-1-错误尝试"><a href="#2-1-错误尝试" class="headerlink" title="2.1 错误尝试"></a>2.1 错误尝试</h3><p>实践其实很简答，配置设置自动模式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">ttl:</span> <span class="number">5000</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure><p>然后消费逻辑如此而已</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = &#123;RabbitMQConfig.ORDER_QUEUE&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveOrderMessage</span><span class="params">(String msg, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"接受订单的消息: &#123;&#125;"</span>, msg);</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果发现消费端确实无限循环消费，如第一贴博主所说。而且这个情况完全跟这边文章中的消息无限投递一样 <a href="https://juejin.im/post/6844904205438681095" target="_blank" rel="noopener">用了 springboot + rabbitmq 消息确认机制，我感觉掉坑里了</a></p><p>消息被无限循环投递，消费端无限循环消费</p><blockquote><p>可以在消费日志看到 Delivery Tag 一直在增加</p></blockquote><p>其中rabbitmq UI看到如下</p><p><img src="/images/rabbitmq/auto_ack-unack.png" alt=""></p><p>当停止消费程序, 消息重新回到ready状态, 该图略</p><p>这个情况让我有点诧异。自动ack居然跟手工ack 下 nack 重回队列完全一致</p><blockquote><p><strong>更多尝试</strong><br>通过开启重试机制，设置<code>最大重试次数</code>可以避免消息无限重复投递，此种情况则符合<code>fire-and-forget</code>, 即使没有catch住异常。</p><ul><li>达到最大重试次数，即使消费还失败，此时队列会删除该消息</li><li>rabbitmq只发送一次，重试是在消费端内部进行，重试时Delivery Tag不变</li></ul></blockquote><hr><p>然后稍微修改了下代码，catch住异常</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = &#123;RabbitMQConfig.ORDER_QUEUE&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveOrderMessage</span><span class="params">(String msg, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"接受订单的消息: &#123;&#125;"</span>, msg);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> a = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(message.getMessageProperties().getDeliveryTag() + <span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果就发现没有无限循环投递跟消费情况</p><p>demo地址: <a href="https://github.com/mugbya/Java-Collection/tree/master/springboot-rabbitmq" target="_blank" rel="noopener">点击查看</a></p><blockquote><p>注意：demo很可能进行其他试验调整，还请相应更改</p></blockquote><h3 id="2-2-拨乱反正"><a href="#2-2-拨乱反正" class="headerlink" title="2.2 拨乱反正"></a>2.2 拨乱反正</h3><p>上面做了demo，还导致我做出了一个(<strong>错误</strong>)的总结。但是我心里确纳闷，为啥java没有严格按照规范实现。心里有刺，去了技术群询问，也去了别的博文留言，结果别人心细一下就找到问题。先感谢下博主的回答<a href="https://segmentfault.com/a/1190000022763182?_ea=67081401" target="_blank" rel="noopener">RabbitMQ - 消息确认</a></p><p><code>spring.rabbitmq.listener.simple.acknowledge-mode</code> 也有是三个值</p><ul><li>none: 这才是自动确认</li><li>auto: 根据情况确认(根据是正常返回还是引发异常来发出确认/否定)</li><li>manual: 手工确认</li></ul><p>源码 <code>org.springframework.amqp.core.AcknowledgeMode</code> 定义如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * No acks - &#123;@code autoAck&#x3D;true&#125; in &#123;@code Channel.basicConsume()&#125;.</span><br><span class="line"> *&#x2F;</span><br><span class="line">NONE,</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Manual acks - user must ack&#x2F;nack via a channel aware listener.</span><br><span class="line"> *&#x2F;</span><br><span class="line">MANUAL,</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Auto - the container will issue the ack&#x2F;nack based on whether</span><br><span class="line"> * the listener returns normally, or throws an exception.</span><br><span class="line"> * &lt;p&gt;&lt;em&gt;Do not confuse with RabbitMQ &#123;@code autoAck&#125; which is</span><br><span class="line"> * represented by &#123;@link #NONE&#125; here&lt;&#x2F;em&gt;.</span><br><span class="line"> *&#x2F;</span><br><span class="line">AUTO;</span><br></pre></td></tr></table></figure><blockquote><p>所以一定要注意 none 才是自动确认啊！！！ </p></blockquote><p>当acknowledge-mode设置为none时，这回真的做到了<code>fire-and-forget</code></p><h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h2><h3 id="3-1-错误总结"><a href="#3-1-错误总结" class="headerlink" title="3.1 错误总结"></a>3.1 错误总结</h3><p>至此，我有如下看法：springboot-rabbitmq 的自动ack，<del>并没有如 <code>fire-and-forget</code> 实现，而是消费逻辑处理完成就会自动返回ack, catch住异常保证了程序正常运行，如果没有，则一旦异常，消费端就不会返回 ack。而是返回的类似nack requeue=true 这种</del>.</p><p><del>所以并不存在发送就丢弃的情况，不知道是否在实现自动ack进行的改良</del></p><br><h3 id="3-2-再次总结"><a href="#3-2-再次总结" class="headerlink" title="3.2 再次总结"></a>3.2 再次总结</h3><p>自动应答模式下(none)：发送后即丢弃。即使消息消费异常<br>动态模式下(auto): 消费正常，则自动应答。 如果异常且没有处理，则返回nack, requeue=true</p><h2 id="4-结尾"><a href="#4-结尾" class="headerlink" title="4.结尾"></a>4.结尾</h2><p>在写博客一直避免 以其昏昏，使人昭昭。 因为我曾经被错误的博客误导，所以想自己的博客不会误导别人。</p><p>这次明显发现冲突的地方，但是却没有真正点击进去查看到底有哪些参数, 这个错误犯的真是低级！</p><p>记录下完整的经过，时时回来看该篇文章，以便提醒自己做事细心谨慎，慢慢改变自己不谨慎的毛病</p>]]></content>
      
      
      <categories>
          
          <category> rabbitmq </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES之集群自动发现</title>
      <link href="/es-discovery/"/>
      <url>/es-discovery/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该篇是从 <a href="http://blog.mugbya.me/2020/05/26/ES%E7%89%88%E6%9C%AC%E5%8F%98%E5%8C%96%E5%8F%B2/">ES版本变化史</a> 中单独抽出来的</p></blockquote><h2 id="1-历史"><a href="#1-历史" class="headerlink" title="1. 历史"></a>1. 历史</h2><p>在 5、6版本中，集群发现由 <code>Zen discovery</code> 内置模块负责，它提供单播和基于文件的发现，也可以通过扩展插件支持云环境和其他形式的发现。</p><p><code>Zen discovery</code> 包含如下一些模块</p><ul><li><p>ping: 使用ping方式发现别的机器</p></li><li><p>seed nodes: 简而言之，所有节点机器配置相同的 初始种子节点(master类型的节点)，然后种子节点先启动，后面别的节点启动后就找种子节点，通过种子节点来完成集群发现</p><blockquote><p>使用 cassandra 的用户应该很熟悉 seed nodes 这个配置</p></blockquote></li></ul><p>seed nodes 实现分为两种方式：Unicast(单播)、file-based(文件方式)</p><ul><li><p>Unicast: 使用该参数配置 <code>discovery.zen.ping.unicast.hosts</code></p></li><li><p>file-based：使用外部文件来配置种子节点。当文件更改时，ES无需重启而会自动加载该文件</p></li></ul><table><thead><tr><th>发现方式</th><th>差异</th></tr></thead><tbody><tr><td>Unicast(单播)</td><td>静态：改动所有节点<code>需要</code>会重启</td></tr><tr><td>file-based(文件)</td><td>动态：改动所有节点 <code>无需</code> 重启</td></tr></tbody></table><br><p><code>Unicast(单播)</code> 的配置形式如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> <span class="string">["12.12.12.12:10801"]</span></span><br></pre></td></tr></table></figure><br><p>要是用文件方式，则需要先在 <code>elasticsearch.yml</code>进行如下配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">discovery.zen.hosts_provider:</span> <span class="string">file</span></span><br></pre></td></tr></table></figure><p><code>file-based</code>的配置路径在： <code>$ES_PATH_CONF/unicast_hosts.txt</code>, 形式如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.5</span></span><br><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.6</span><span class="string">:9305</span></span><br><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.5</span><span class="string">:10005</span></span><br><span class="line"><span class="comment"># an IPv6 address</span></span><br><span class="line"><span class="string">[2001:0db8:85a3:0000:0000:8a2e:0370:7334]:9301</span></span><br></pre></td></tr></table></figure><p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/modules-discovery-zen.html" target="_blank" rel="noopener">ES官方6.8</a></p><h2 id="2-新版"><a href="#2-新版" class="headerlink" title="2. 新版"></a>2. 新版</h2><p>在 7 以后的版本 就不在提 <code>Zen discovery</code>, 不过还是使用的 <code>seed nodes</code> 方式，也支持静态更动态两种配置。不同的是 <strong><code>参数名发生了变化</code></strong>。</p><p>在 7 版本就不提Unicast(单播) 了，而是 <code>settings-based</code> ，file-based(文件)则不变。</p><p><code>settings-based</code> 的配置形式如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">discovery.seed_hosts:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span><span class="string">:9300</span></span><br><span class="line">   <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span> </span><br><span class="line">   <span class="bullet">-</span> <span class="string">seeds.mydomain.com</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>注</strong></p><p>如果不指定端口，则默认为 transport.port</p></blockquote><p>要是用文件方式，则需要先在 <code>elasticsearch.yml</code>进行如下配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">discovery.seed_providers:</span> <span class="string">file</span></span><br></pre></td></tr></table></figure><p><code>file-based</code>的配置路径在： <code>$ES_PATH_CONF/unicast_hosts.txt</code>, 形式如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.5</span></span><br><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.6</span><span class="string">:9305</span></span><br><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.5</span><span class="string">:10005</span></span><br><span class="line"><span class="comment"># an IPv6 address</span></span><br><span class="line"><span class="string">[2001:0db8:85a3:0000:0000:8a2e:0370:7334]:9301</span></span><br></pre></td></tr></table></figure><p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.8/modules-discovery-hosts-providers.html" target="_blank" rel="noopener">ES官方7.0</a></p>]]></content>
      
      
      <categories>
          
          <category> elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>freeswitch-1.6部署-01</title>
      <link href="/freeswitch-1-6-deploy-01/"/>
      <url>/freeswitch-1-6-deploy-01/</url>
      
        <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">首先强调下环境：</span> <span class="string">centos6</span>  <span class="string">freeswitch1.6</span></span><br></pre></td></tr></table></figure><h2 id="1-基础"><a href="#1-基础" class="headerlink" title="1.基础"></a>1.基础</h2><p>一开始是很不想写这篇文章的，网上部署的文章还是蛮多，官方也给出了各个版本下的部署文档 <a href="https://freeswitch.org/confluence/display/FREESWITCH/Archived+Linux+Installation+Instructions" target="_blank" rel="noopener">Archived Linux Installation Instructions</a></p><p>不过发现照着做还是搞了很多，主要是差了很多依赖。官方给出的依赖如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git gcc-c++ autoconf automake libtool wget python ncurses-devel zlib-devel libjpeg-devel openssl-devel e2fsprogs-devel sqlite-devel libcurl-devel pcre-devel speex-devel ldns-devel libedit-devel</span><br></pre></td></tr></table></figure><p>不过在实际过程中遇到很多问题，如</p><ul><li>错误提示: You must install libopus-dev to build mod_opus</li><li>错误提示: Neither yasm nor nasm have been found</li><li>错误提示:  找不到 lua.h 等lua的头文件</li></ul><p>每安装一个依赖后，然后去make发现又有新的问题，所以这里在依赖给出更全面一点，但是不保证在任何环境都适用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git gcc-c++ autoconf automake libtool wget python ncurses-devel zlib-devel libjpeg-devel openssl-devel e2fsprogs-devel sqlite-devel libcurl-devel pcre-devel speex-devel ldns-devel libedit-devel yasm lua lua-devel opus-devel</span><br></pre></td></tr></table></figure><p>安装执行如下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /usr/src</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> -b v1.6 https://github.com/signalwire/freeswitch.git</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> freeswitch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bootstrap.sh -j</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure -C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> make sounds-install</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> make moh-install</span></span><br></pre></td></tr></table></figure><p>最终安装完后如下图</p><p><img src="/images/freeswitch/install.png" alt=""></p><p>启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/freeswitch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bin/freeswitch</span></span><br></pre></td></tr></table></figure><p>查看启动过程中是否出现 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2020-09-18 16:58:44.243406 [INFO] sofia.c:5782 Setting MAX Auth Validity to 0 Attempts</span><br><span class="line">2020-09-18 16:58:44.275457 [ERR] sofia.c:3146 Error Creating SIP UA for profile: internal-ipv6 (sip:mod_sofia@[::1]:5060;transport&#x3D;udp,tcp) ATTEMPT 1 (RETRY IN 5 SEC)</span><br><span class="line">2020-09-18 16:58:44.276436 [INFO] switch_core_sqldb.c:1693 sofia:external Starting SQL thread.</span><br><span class="line">2020-09-18 16:58:44.276636 [NOTICE] sofia_reg.c:3398 Added gateway &#39;example.com&#39; to profile &#39;external&#39;</span><br><span class="line">2020-09-18 16:58:44.278290 [ERR] sofia.c:3146 Error Creating SIP UA for profile: external-ipv6 (sip:mod_sofia@[::1]:5080;transport&#x3D;udp,tcp) ATTEMPT 1 (RETRY IN 5 SEC)</span><br><span class="line">2020-09-18 16:58:44.518954 [NOTICE] sofia.c:5949 Started Profile internal [sofia_reg_internal]</span><br><span class="line">2020-09-18 16:58:44.519047 [WARNING] sofia.c:2206 MSG Thread 0 Started</span><br></pre></td></tr></table></figure><p>里面 ERR 是因为机器没有开启 ipv6. 如何确定请参考： <a href="https://www.jianshu.com/p/bb951b2c76b6" target="_blank" rel="noopener">Linux关闭、开启、配置IPv6</a></p><p>解决方式：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/freeswitch/conf/sip_profiles</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir bak</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> mv *-ipv6* back</span></span><br></pre></td></tr></table></figure><h2 id="2-配置介绍"><a href="#2-配置介绍" class="headerlink" title="2.配置介绍"></a>2.配置介绍</h2><p>配置文件在 /usr/local/freeswitch/conf 下，下面是conf下的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">├── autoload_configs</span><br><span class="line">├── chatplan</span><br><span class="line">├── dialplan</span><br><span class="line">│   ├── default</span><br><span class="line">│   ├── public</span><br><span class="line">│   └── skinny-patterns</span><br><span class="line">├── directory</span><br><span class="line">│   └── default</span><br><span class="line">├── ivr_menus</span><br><span class="line">├── jingle_profiles</span><br><span class="line">├── lang</span><br><span class="line">├── mrcp_profiles</span><br><span class="line">├── sip_profiles</span><br><span class="line">│   ├── back</span><br><span class="line">│   │   └── external-ipv6</span><br><span class="line">│   └── external</span><br><span class="line">└── skinny_profiles</span><br></pre></td></tr></table></figure><ul><li><strong>autoload_configs</strong>：存放自动加载的配置文件</li><li>chatplan：存放的是聊天计划配置文件</li><li><strong>dialplan</strong>：存放的是拨号计划配置文件</li><li><strong>directory</strong>：用户目录，存储跟用户相关的信息</li><li>ivr_menus：IVR菜单配置文件</li><li>jingle_profiles：连接Google Talk的相关配置文件</li><li>lang：多语言支持配置文件</li><li>mrcp_profiles：MRCP的相关配置，用于跟第三方语音合成和语音识别系统对接。</li><li><strong>sip_profiles</strong>：sip配置文件</li><li>skinny_profiles：思科SCCP协议话机的配置文件</li></ul><blockquote><p>autoload_configs: 文件夹下的modules.conf.xml：表示当freeswitch启动时自动装载哪些模块。此文件夹下其它xml：一般来说都是对应每个模块的配置文件</p><p>directory: 此文件夹下的的defalut目录是默认的用户目录配置，default下的xml文件是对应每个sip用户的，每个sip用户都有一个配置文件</p><p>sip_profiles: 此文件夹下的internal.xml：一个SIP profile，或称作一个SIP-UA，监听在本地IP及端口5060.此文件夹下的externa.xml：另一个SIP-UA，用作外部连接，端口5080。</p></blockquote><h2 id="3-感谢"><a href="#3-感谢" class="headerlink" title="3.感谢"></a>3.感谢</h2><p>在安装过程中这篇博文帮助很大</p><ul><li><a href="https://www.cnblogs.com/hezhixiong/p/4797511.html" target="_blank" rel="noopener">FreeSWITCH安装报错</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> freeswitch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES之简介close与freeze</title>
      <link href="/es-close-freeze/"/>
      <url>/es-close-freeze/</url>
      
        <content type="html"><![CDATA[<h2 id="1-缘起"><a href="#1-缘起" class="headerlink" title="1.缘起"></a>1.缘起</h2><p>上次在群里看到彬哥分享的 ILM 后, 自己使用7.9版本是试用了下，很棒，解决之前索引管理的麻烦(以前都是程序中处理)</p><p>然后我把ILM分享给部门负责人，然后让我演示其用法，在演示后，部门负责人提出一个问题，在cold节点的index能否close, 因为IML是一直在增加索引的，担心索引太多造成集群性能问题，如果能把cold节点的index关闭就更好了</p><h2 id="2-探索及结果"><a href="#2-探索及结果" class="headerlink" title="2.探索及结果"></a>2.探索及结果</h2><p>拿到这个问题，我还真的第一时间就朝着 close index 去了, 去翻了 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ilm-actions.html" target="_blank" rel="noopener">Index lifecycle actions</a>, 发现没有 close 这个行为。也去群里问了，结果群友推荐 curator, 我查了下，并不适用于iml中(因为自动管理后，我也不知道哪些index在什么时候就到cold节点了)</p><p>然后继续搜索，发现 <a href="https://www.elastic.co/cn/blog/creating-frozen-indices-with-the-elasticsearch-freeze-index-api" target="_blank" rel="noopener">使用 Elasticsearch Freeze index API 创建冻结索引</a> 这篇文章, 发现 freeze index，同样消耗集群资源很少，只需要维护一些元数据</p><p>在官方 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.6/freeze-index-api.html" target="_blank" rel="noopener">freeze-index-api</a> 也有说明</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">A</span> <span class="string">frozen</span> <span class="string">index</span> <span class="string">has</span> <span class="string">almost</span> <span class="literal">no</span> <span class="string">overhead</span> <span class="string">on</span> <span class="string">the</span> <span class="string">cluster</span> <span class="string">(except</span> <span class="string">for</span> <span class="string">maintaining</span> <span class="string">its</span> <span class="string">metadata</span> <span class="string">in</span> <span class="string">memory),</span> <span class="string">and</span> <span class="string">is</span> <span class="string">blocked</span> <span class="string">for</span> <span class="string">write</span> <span class="string">operations.</span></span><br></pre></td></tr></table></figure><p>实践也发现，直接按照日常搜索是检索不到位于cold节点的数据，只要加了 <code>ignore_throttled=false</code> 后，才能检索到cold 节点的数据</p><p>这个完全能达到部门负责人的需求，直接反馈</p><h2 id="3-对比"><a href="#3-对比" class="headerlink" title="3.对比"></a>3.对比</h2><p><strong>close</strong></p><p>当close index后，集群几乎没有开销，除了在内存中维护元数据，同时index即不能写，也不能读，要操作需要open index。</p><blockquote><p><strong>注意</strong></p><p>Elasticsearch不会在任何close的index中重建丢失的分片副本。 随着时间的推移，替换群集中的节点时，所有封闭索引的分片数据将逐渐丢失。</p></blockquote><p><strong>freeze</strong></p><p>freeze index后，集群几乎没有开销，除了在内存中维护元数据，此时index可以读，但是不能写入</p><blockquote><p>freeze 是在ES 6.6 版本引入的</p></blockquote><p>总结: 偶尔要被检索的cold数据就用freeze就行，不需要在去close。 iml close policy 可以配置成 freeze, 可以iml真的是好用啊</p>]]></content>
      
      
      <categories>
          
          <category> elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES之doc_values与fielddata</title>
      <link href="/es-doc-values-fielddata/"/>
      <url>/es-doc-values-fielddata/</url>
      
        <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">本文档适用范围：大部分描述适用于所有的es版本，部分内容适用于</span> <span class="number">5</span><span class="string">.*</span> <span class="string">版本以上</span></span><br></pre></td></tr></table></figure><h2 id="1-自白"><a href="#1-自白" class="headerlink" title="1. 自白"></a>1. 自白</h2><p>ES除了搜索十分优秀之外，聚合排序也还十分好用。</p><p>博主以前使用聚会功能场景不算太多，能写简答聚合语句。所以对里面很多东西知之甚少，偶然会遇到一些问题，能够找到解决方式，但是没有形成体系。</p><p>在一次部门技术负责人分享ES时，我才知道以前用的遇到的问题跟 <code>doc_values</code> 与 <code>fielddata</code> 相关；也更清楚知道聚合是如何实现的</p><p>本文先介绍聚合相关基础部分，慢慢由浅到深入</p><h2 id="2-基础"><a href="#2-基础" class="headerlink" title="2. 基础"></a>2. 基础</h2><p>搜索我默认你都用过，而且也知道 <code>倒排索引</code> 是什么。</p><p>在聚合时需要另一种 <strong>数据结构</strong> 来支持聚合，这种数据结构就是 <code>Doc Values</code>，本篇只有基础。</p><h3 id="2-1-Doc-Values"><a href="#2-1-Doc-Values" class="headerlink" title="2.1 Doc Values"></a>2.1 Doc Values</h3><ul><li><p><strong>概念</strong>：是一种结构，存储 文档 与 <code>term</code> 的<code>正排索引</code>，也可以点击查看<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/doc-values.html" target="_blank" rel="noopener">官方定义</a></p></li><li><p><strong>作用与特性</strong>：用于聚合，排序，大部分字段默认支持并开启 doc_values, <code>text</code>类型不支持</p></li><li><p><strong>时机</strong>：在文档被索引时，跟 <code>倒排索引是同时发生的</code></p></li><li><p><strong>存储地方</strong>：磁盘</p><blockquote><p>对于这一点存在疑问，在 2.*版本提到 “当 <code>working set</code> 远小于系统的可用内存，系统会自动将 <code>Doc Values</code> 驻留在内存中，使得其读写十分快速；不过，当其远大于可用内存时，系统会根据需要从磁盘读取 <code>Doc Values</code>，然后选择性放到分页缓存中”</p><p>但是在后别的版本并没有这样的描述，反而 <code>doc_values</code> 的表述更多跟 on-disk 联系在一起</p><p>参考链接： <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_deep_dive_on_doc_values.html" target="_blank" rel="noopener">深入理解 Doc Values</a></p></blockquote></li></ul><p>参考链接</p><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/doc-values.html#doc-values" target="_blank" rel="noopener">官方doc_values</a></li><li><a href="https://www.cnblogs.com/bonelee/p/6401531.html" target="_blank" rel="noopener">doc_values介绍</a></li></ul><h3 id="2-2-fielddata"><a href="#2-2-fielddata" class="headerlink" title="2.2 fielddata"></a>2.2 fielddata</h3><p>上面我们知道 text 类型不支持 <code>Doc Values</code>，故此ES又搞出一个查询时的数据结构 ，然后这个结构就叫 <code>fielddata</code></p><p>官方文档解释</p><blockquote><p>Most fields can use index-time, on-disk <code>doc_values</code> for this data access pattern, but<code>text</code> fields do not support doc_values.</p><p>Instead, text fields use a query-time in-memory data structure called fielddata. This data structure is built on demand the first time that a field is used for aggregations, sorting, or in a script. It is built by reading the entire inverted index for each segment from disk, inverting the term ↔︎ document relationship, and storing the result in memory, in the JVM heap.</p></blockquote><p>根据上面的叙述 能够明确 <code>fielddata</code> 是 <code>doc_values</code> 的补充</p><ul><li><p><strong>概念</strong>：是一种结构，存储 文档 与 <code>term</code> 的<code>正排索引</code></p></li><li><p><strong>作用与特性</strong>：用于聚合，排序，专门用来解决 <code>text</code> 类型不能统计，聚合</p></li><li><p><strong>时机</strong>：在文档被<strong>查询</strong>时</p></li><li><p><strong>存储地方</strong>：内存</p></li></ul><p>继续看官方文档</p><blockquote><p> <strong>Fielddata is disabled on text fields by defaultedit</strong></p><p>Fielddata can consume a lot of heap space, especially when loading high cardinality text fields. Once fielddata has been loaded into the heap, it remains there for the lifetime of the segment. Also, loading fielddata is an expensive process which can cause users to experience latency hits. This is why fielddata is disabled by default.</p><p>If you try to sort, aggregate, or access values from a script on a text field, you will see this exception:</p><p>Fielddata is disabled on text fields by default.  Set <code>fielddata=true</code> on<br>[<code>your_field_name</code>] in order to load  fielddata in memory by uninverting the<br>inverted index. Note that this can however use significant memory.</p></blockquote><p>text 默认情况下也是 禁止了 Fielddata 的，因为开启会消耗大量 堆空间。简而言之开启的代价很昂贵，如果是在线系统开启，则有可能导致用户访问延迟</p><p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/fielddata.html" target="_blank" rel="noopener">官方7.7 - fielddata</a></p><h2 id="3-优化"><a href="#3-优化" class="headerlink" title="3. 优化"></a>3. 优化</h2><p>在介绍基础时，顺便把相关的优化也介绍了。</p><p>由上文我们知道 <code>Doc Values</code> 这种数据结构跟 <code>倒排索引</code> 一样，都是在创建时就建立，需要消耗cpu,跟磁盘。单条插入时这个消耗其实并一定体现很大，如果是批量导入大量数据，可能会帮助你提升下。最好是你不要聚合，那么就可以关掉这个</p><p>再次提醒，除非你明确需求不会有聚合功能，否则不要禁用 <code>Doc Values</code>。</p><p>当然你也可以用一个索引只做搜索支持在线业务，然后有聚合需求时使用 <code>reindex</code> 搞一个线下的index来进行统计分析</p><p>如果你统计分析也需要提供线上服务，就别禁用了</p><p>放上禁用的例子</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PUT</span> <span class="string">my_index</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">  <span class="attr">"mappings":</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"type":</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">"properties":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"id":</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">"type":</span> <span class="string">"keyword"</span><span class="string">,</span></span><br><span class="line">          <span class="attr">"doc_values":</span> <span class="literal">false</span></span><br><span class="line">        <span class="string">&#125;,</span></span><br><span class="line">        <span class="attr">"valye":</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">"type":</span> <span class="string">"keyword"</span><span class="string">,</span></span><br><span class="line">          <span class="attr">"doc_values":</span> <span class="literal">false</span></span><br><span class="line">        <span class="string">&#125;,</span></span><br><span class="line">        <span class="attr">"status":</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">"type":</span> <span class="string">"integer"</span><span class="string">,</span></span><br><span class="line">          <span class="attr">"doc_values":</span> <span class="literal">false</span></span><br><span class="line">        <span class="string">&#125;,</span></span><br><span class="line">        <span class="attr">"desc":</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">"type":</span> <span class="string">"keyword"</span><span class="string">,</span></span><br><span class="line">          <span class="attr">"doc_values":</span> <span class="literal">false</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><blockquote><p><strong>总结</strong><br>fielddata 与 doc_values 不同的地方在于 </p><ol><li>支持的类型</li><li>创建的时机</li><li>存储的地方</li></ol></blockquote><p><code>text</code> 字段很特殊，为了能够支持 复杂搜索，所以ES做了 <code>倒排索引</code>来支持</p><p>但还要做另一不同需求 统计，聚合这种，却不能使用 <code>倒排索引</code>来做，又做了 <code>正排索引</code>（doc_values）</p><p><code>doc_values</code> 默认支持大多数字段，但是不支持 <code>text</code>类型， 可以看下图</p><p><img src="https://i.imgur.com/3wyMRa4.png" alt=""></p><p>然后ES 为了支持 <code>text</code>类型，又搞出 <code>fielddata</code>结构</p><p>但是 <code>text</code>类型不能被用于 聚合的问题 ES 还给出了另一个方案，那就是 给出 一个 <code>keyword</code>不分词的字段</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PUT</span> <span class="string">my_index</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">  <span class="attr">"mappings":</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"properties":</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">"my_field":</span> <span class="string">&#123;</span> </span><br><span class="line">        <span class="attr">"type":</span> <span class="string">"text"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"fields":</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">"keyword":</span> <span class="string">&#123;</span> </span><br><span class="line">            <span class="attr">"type":</span> <span class="string">"keyword"</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>总之 <code>fielddata</code> 要慎用，想清楚再用</p>]]></content>
      
      
      <categories>
          
          <category> elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo主题maupassant优化却失败</title>
      <link href="/Hexo-maupassant/"/>
      <url>/Hexo-maupassant/</url>
      
        <content type="html"><![CDATA[<h2 id="1-自白"><a href="#1-自白" class="headerlink" title="1. 自白"></a>1. 自白</h2><p>重开博客, 发现以前的博客样子不怎么好看，就在<code>hexo</code>的 theme 库里选了很久，结果都没有选到自己喜欢的主题</p><p>但在浏览博客时却发现一个喜欢的主题，找了很久终于知道叫 <a href="https://github.com/pagecho/maupassant/" target="_blank" rel="noopener">maupassant</a>, 不过找到的是 jekyll 的，不过最下面有 hexo 下的主题</p><p>使用时才知道它的目录是放在 文章的右侧，而不是在挂件(widget)的区域, 然后就尝试修改,想改成widget下的一个子挂件</p><p>然后我就开始了自我尝试</p><h2 id="2-修改"><a href="#2-修改" class="headerlink" title="2. 修改"></a>2. 修改</h2><p>然后说下修改部分, <code>maupassant</code> 本身是支持 toc 的，故此修改的部分不算多</p><ol><li><p>首先是在 _widget 下增加 <code>tag.pug</code>, 内容如下</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">.widget</span></span><br><span class="line"><span class="string">.widget-title</span></span><br><span class="line">  <span class="string">i(class='fa</span> <span class="string">fa-folder-o')=</span> <span class="string">' '</span> <span class="string">+</span> <span class="string">__('contents')</span></span><br><span class="line"><span class="string">!=</span> <span class="string">toc(page.content,</span> <span class="string">&#123;list_number:</span> <span class="string">theme.toc_number&#125;)</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>提示</strong></p><p>有关 pug语法问题 <a href="https://pugjs.org/api/getting-started.html" target="_blank" rel="noopener">请点击这里</a>，里面详细解释了<code>!=</code> 这是什么东西，以及其他一些用法</p></blockquote></li><li><p>修改 <code>maupassant/_config.yml</code></p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 toc_number</span></span><br><span class="line"><span class="attr">toc_number:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">widgets:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="string">toc</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">search</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure></li></ol><ol start="3"><li><p>修改样式</p> <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.toc-article</span> &#123;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#bbb</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">7px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">1.1em</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2em</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.7em</span> <span class="number">0.7em</span> <span class="number">0</span> <span class="number">0.7em</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">40%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.toc-title</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">120%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.toc</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0.5em</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1.8em</span>;</span><br><span class="line">    li &#123;</span><br><span class="line">        <span class="selector-tag">list-style-type</span>: <span class="selector-tag">none</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.toc-child</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">1em</span>;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><hr><p>然后它就长这样</p><p><img src="/images/hexo-toc-01.png" alt=""></p><h2 id="3-问题"><a href="#3-问题" class="headerlink" title="3. 问题"></a>3. 问题</h2><p>但是最后发现一个严重问题 ———— 不在文章详情页面时，也会有这个目录，包括首页，归档，这个就不对了！！！</p><p>但是我探究了很久我都搞不定这个问题，探究的结果是  <strong>widget里面的变量全都变成了全局变量，即使页面发生变化但里面的变量的值还是初次的赋值</strong></p><p>目前只能探究到这，写下此篇文章，等有机会再来搞定它。</p><p>最终我只能全部撤回，使用默认的目录</p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术 </tag>
            
            <tag> maupassant </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES版本变化史</title>
      <link href="/es-version-history/"/>
      <url>/es-version-history/</url>
      
        <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">本篇讲述ES的变化带来的影响，不同版本可能有些东西不一定，需要注意</span></span><br></pre></td></tr></table></figure><h2 id="1-版本介绍"><a href="#1-版本介绍" class="headerlink" title="1. 版本介绍"></a>1. 版本介绍</h2><table><thead><tr><th>版本</th><th>文档</th></tr></thead><tbody><tr><td>0.9</td><td><a href="https://www.elastic.co/guide/en/elasticsearch/reference/0.9/getting-started.html" target="_blank" rel="noopener">0.9-Getting Started</a></td></tr><tr><td>1.*</td><td><a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.0/getting-started.html" target="_blank" rel="noopener">1.3-Getting Started</a></td></tr><tr><td>2.*</td><td><a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.0/getting-started.html" target="_blank" rel="noopener">2.0-Getting Started</a></td></tr><tr><td>5.*</td><td><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.0/getting-started.html" target="_blank" rel="noopener">5.0-Getting Started</a></td></tr><tr><td>6.*</td><td><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.0/getting-started.html" target="_blank" rel="noopener">6.0-Getting Started</a></td></tr><tr><td>7.*</td><td><a href="https://www.elastic.co/guide/en/elastic-stack-get-started/current/index.html" target="_blank" rel="noopener">Getting Started</a></td></tr></tbody></table><p>5.0 应该是变化最大的版本，有兴趣关注5.0变化的请点击<a href="https://www.infoq.cn/article/2016/08/Elasticsearch-5-0-Elastic/" target="_blank" rel="noopener">大数据杂谈微课堂|Elasticsearch 5.0 新版本的特性与改进</a></p><blockquote><p><strong>提示</strong></p><p>中间没有3.* 跟 4.* 跳过这两个版本是因为 elasticsearch 要保持全家桶版本一致</p><p><del>当前版本 7.3</del><br><del>当前版本 7.8</del><br>当前版本 7.9</p></blockquote><p>在使用的时候经常 看到有人用 <code>string</code>类型，然后再在基础上写博客。当然这不是说它本身是错的，但是因为 ES 版本变化原因，导致很多细节已经在别的版本中不能在适用了，故本文对这种变更东西进行梳理</p><h2 id="2-详情"><a href="#2-详情" class="headerlink" title="2. 详情"></a>2. 详情</h2><h3 id="2-1-type"><a href="#2-1-type" class="headerlink" title="2.1 type"></a>2.1 type</h3><h3 id="2-2-string-类型"><a href="#2-2-string-类型" class="headerlink" title="2.2 string 类型"></a>2.2 string 类型</h3><p>在 5版本 以前都有 <code>string</code>类型，但是在 5.*版本开始已经移除了 该类型。</p><blockquote><h3 id="移除背景及缘由"><a href="#移除背景及缘由" class="headerlink" title="移除背景及缘由"></a>移除背景及缘由</h3><p>因为ElasticSearch对字符串拥有两种完全不同的搜索方式. 你可以按照整个文本进行匹配, 即关键词搜索(keyword search), 也可以按单个字符匹配, 即全文搜索(full-text search). 对ElasticSearch稍有了解的人都知道, 前者的字符串被称为<code>not-analyzed</code>字符, 而后者被称作<code>analyzed</code>字符串.</p><p>同一种类型用于应对两种不同的使用场景是会让人崩溃的, 因为有些选项只对其一的场景设置有效.例如<code>position_increment_gap</code>对<code>not-analyzed</code>字符就不会起作用, 而像<code>ignore_above</code>对于<code>analyzed</code>字符串就很难区分它到底是对整个字符串的值有效还是对单独的每个分词有效(在这种场景, ignore_above确实只对整个字符串值有效, 而对单个分词的限制可以使用<code>limit</code>设置).</p></blockquote><p>最终 <code>string</code>字段被拆分成两种新的数据类型: <code>text</code>用于全文搜索的, 而<code>keyword</code>用于关键词搜索.</p><hr><p>在7.9 增加 wildcard 类型。 用来通配搜索，该类型字段的统配搜索要比以前更快, 详情参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/wildcard.html" target="_blank" rel="noopener">Wildcard field type</a></p><p>参考链接：<a href="https://segmentfault.com/a/1190000008897731" target="_blank" rel="noopener">ElasticSearch数据类型–string类型已死, 字符串数据永生</a></p><h3 id="3-参数"><a href="#3-参数" class="headerlink" title="3 参数"></a>3 参数</h3><ul><li><a href="http://blog.mugbya.me/2020/09/18/ES%E4%B9%8B%E9%9B%86%E7%BE%A4%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0/">集群自动发现</a></li></ul><h2 id="changelog"><a href="#changelog" class="headerlink" title="changelog"></a>changelog</h2><ul><li>2020-07-13以前: 略</li><li>2020-07-13: 自动发现</li><li>2020-09-18: 移除自动发现详情, 增加 wildcard 类型</li></ul>]]></content>
      
      
      <categories>
          
          <category> elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
